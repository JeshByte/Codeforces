To solve this one, we need to first refactor our approach for the easy version of this problem. Lets say we start with 5. With 5 we turn it into 5 6 6. The using the first 6 we turn it into 5 6 7 6. Then we use the 7 to turn it into 5 6 7 8 6. Then we use the last 6 to turn it into 5 6 7 8 6 7. Now we can reverse these operations using a stack. We will go from right to left, and for every element ai we will delete all the elements ai-1 at the top of the stack and then push the element into the stack. So we first insert 7. Then with 6, we delete 7 and insert 6. Then we insert 8. Then we delete 8 with 7 and insert 7. We then delete 7 with 6. Then we delete both the 6s with 5. The stack at the end has 5, which is our initial sequence. So in this way we can find the answer for the entire array. But for this problem we need to find the sum of the answers for all the subsegments of the array. So when we applied this algo on the entire array, we are left with 5. It is the only one which survived i.e. it couldnt be destroyed/generated by any other number. So if we think backwards from here, we could just find the no of subsegments each element survives in and add that to get our answer. Now lets go back to our original algo. Lets consider the case of when the rightmost 6 got deleted by the 5. So this 6 survived all the segments starting with it which are (6) and (6,7). Now to get the other possible subsegments we just need to add the elements between 5 and 6 one by one to these subsegments only. So first by adding 8 we get (8,6) and (8,6,7). By adding 7 we get (7,8,6) and (7,8,6,7) and so on. So basically the number of subsegments comes out to be (no of elements in the array starting from the element which just got destroyed)*(number of elements after the element which did the destruction till and including the element that got destroyed). In our above example the expression will come out as 2*4=8. And for the elements left in the stack after the entire algo is over, we will do the same thing. Just for them the index of the element destroying them will be considered as -1. The sum of all of their contributions will give us the answer.
