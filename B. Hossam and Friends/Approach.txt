We can easily calculate the leftmost unfriend of each element to its right. Lets say its stored in array fr. So for a segment [a,b], we can extend it to [a,b+1] if b+1 is not equal to min(fr[i]) for all i from a to b. Another thing - say starting from a, the segment can extended till b. Then we know for sure that there are (b-a)+1 good segments starting from a. Thus here we can use a 2 pointer approach, to find the number of good segments starting from each a. The only problem is to find min(fr[i]) efficiently. As fr is a static array, we will use a sparse table for that. 
